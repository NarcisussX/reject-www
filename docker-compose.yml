services:
  www:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: www
    restart: unless-stopped
    depends_on:
      - hook
      - api
    networks:
      - tw_web
    labels:
      - traefik.enable=true
      - traefik.docker.network=tw_web
      - traefik.http.services.www.loadbalancer.server.port=80
      - "traefik.http.routers.www.rule=Host(`www.reject.app`)"
      - traefik.http.routers.www.entrypoints=websecure
      - traefik.http.routers.www.tls=true
      - traefik.http.routers.www.service=www
      - "traefik.http.routers.www-apex.rule=Host(`reject.app`)"
      - traefik.http.routers.www-apex.entrypoints=websecure
      - traefik.http.routers.www-apex.tls=true
      - traefik.http.routers.www-apex.service=www
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro

  api:
    build:
      context: ./api
    container_name: reject-api
    environment:
      ADMIN_USER: ${ADMIN_USER}
      ADMIN_PASS: ${ADMIN_PASS}
      DISCORD_WEBHOOK_URL: ${DISCORD_WEBHOOK_URL}
      WATCHLIST_WEBHOOK_URL: ${WATCHLIST_WEBHOOK_URL}
      DB_PATH: /data/reject.db
      NODE_ENV: production
      A4E_AGE_CSV: /app/data/a4e_first_seen_monotone.csv
      DATA_DIR: /app/data 
    tmpfs:
      - /tmp
    volumes:
      - reject_data:/data
      - reject_api_data:/app/data:rw
    entrypoint: ["/bin/sh", "/app/entrypoint.sh"]
    networks:
      - tw_web
    restart: unless-stopped

  hook:
    build:
      context: ./hook
      dockerfile: Dockerfile
    container_name: hook
    restart: unless-stopped
    environment:
      DISCORD_WEBHOOK: "${DISCORD_WEBHOOK_URL}"
    networks:
      - tw_web

networks:
  tw_web:
    external: true
    name: tw_web

volumes:
  reject_data:
  reject_api_data: {}